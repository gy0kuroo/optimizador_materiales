{% extends 'opticut/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'opticut/css/index.css' %}">
{% endblock %}

{% block extra_js %}
<script src="{% static 'opticut/js/medidas-pred.js' %}"></script>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="text-center mb-4" data-intro-title="Optimizador de Cortes" data-intro="Aquí puedes crear nuevas optimizaciones de corte ingresando las dimensiones del tablero y las piezas que necesitas.">Optimizador de Cortes</h2>
  
  <form method="post" action="{% url 'opticut:index' %}" id="optimizacion-form">
    {% csrf_token %}
    
    <!-- Sección: Dimensiones del Tablero -->
    <div class="card mb-4 fade-in" data-intro-title="Dimensiones del Tablero" data-intro="Ingresa el ancho y alto del tablero de madera. Puedes elegir la unidad de medida que prefieras (cm, m, pulgadas o pies).">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h4 class="mb-0">Dimensiones del Tablero</h4>
        <button type="button" class="btn btn-sm btn-light btn-ayuda-seccion" 
                onclick="iniciarTutorialSeccion('tablero')" 
                title="Ayuda sobre dimensiones del tablero">
          ❓
        </button>
      </div>
      <div class="card-body">
        <!-- Dropdown de tableros predefinidos se creará aquí dinámicamente -->
        <div id="medidas-pred-container"></div>
        <div class="row mb-3">
          <div class="col-md-12">
            <div class="d-flex align-items-end gap-3">
              <div class="flex-grow-1">
                {{ tablero_form.unidad_medida.label_tag }}
                {{ tablero_form.unidad_medida }}
                <small class="form-text text-muted">{{ tablero_form.unidad_medida.help_text }}</small>
                {% if tablero_form.unidad_medida.errors %}
                  <div class="text-danger">{{ tablero_form.unidad_medida.errors }}</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="ancho_tablero" id="label_ancho">Ancho del tablero <span id="unidad_ancho">(cm)</span></label>
            {{ tablero_form.ancho }}
            <small class="form-text text-muted">{{ tablero_form.ancho.help_text }}</small>
            {% if tablero_form.ancho.errors %}
              <div class="text-danger">{{ tablero_form.ancho.errors }}</div>
            {% endif %}
          </div>
          <div class="col-md-6 mb-3">
            <label for="alto_tablero" id="label_alto">Alto del tablero <span id="unidad_alto">(cm)</span></label>
            {{ tablero_form.alto }}
            <small class="form-text text-muted">{{ tablero_form.alto.help_text }}</small>
            {% if tablero_form.alto.errors %}
              <div class="text-danger">{{ tablero_form.alto.errors }}</div>
            {% endif %}
          </div>
        </div>
        <!-- Opciones avanzadas -->
        <div class="row mt-3">
          <div class="col-md-6 mb-3">
            <div class="form-check">
              {{ tablero_form.permitir_rotacion }}
              <label class="form-check-label" for="{{ tablero_form.permitir_rotacion.id_for_label }}">
                {{ tablero_form.permitir_rotacion.label }}
              </label>
              <small class="form-text text-muted d-block">{{ tablero_form.permitir_rotacion.help_text }}</small>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <label for="{{ tablero_form.margen_corte.id_for_label }}">{{ tablero_form.margen_corte.label }} <span class="unidad-margen">(mm)</span></label>
            {{ tablero_form.margen_corte }}
            <small class="form-text text-muted">{{ tablero_form.margen_corte.help_text }}</small>
            {% if tablero_form.margen_corte.errors %}
              <div class="text-danger">{{ tablero_form.margen_corte.errors }}</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Sección: Piezas a Cortar -->
    <div class="card mb-4 fade-in">
      <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
        <h4 class="mb-0">Piezas a Cortar</h4>
        <button type="button" class="btn btn-sm btn-light btn-ayuda-seccion" 
                onclick="iniciarTutorialSeccion('piezas')" 
                title="Ayuda sobre piezas a cortar">
          ❓
        </button>
      </div>
      <div class="card-body">
        {{ pieza_formset.management_form }}
        
        <div id="pieza-container">
          {% for form in pieza_formset %}
          <div class="pieza-form border rounded p-3 mb-3 bg-light">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">Pieza #<span class="pieza-numero">{{ forloop.counter }}</span></h5>
              <button type="button" class="btn btn-danger btn-sm remove-pieza {% if forloop.counter <= 1 %}remove-pieza-hidden{% endif %}">
                Eliminar
              </button>
            </div>
            
            <div class="row">
              <div class="col-md-6 mb-2">
                {{ form.nombre.label_tag }}
                {{ form.nombre }}
                <small class="form-text text-muted">{{ form.nombre.help_text }}</small>
              </div>
              <div class="col-md-2 mb-2">
                <label for="{{ form.ancho.id_for_label }}">Ancho <span class="unidad-pieza">(cm)</span></label>
                {{ form.ancho }}
              </div>
              <div class="col-md-2 mb-2">
                <label for="{{ form.alto.id_for_label }}">Alto <span class="unidad-pieza">(cm)</span></label>
                {{ form.alto }}
              </div>
              <div class="col-md-2 mb-2">
                {{ form.cantidad.label_tag }}
                {{ form.cantidad }}
              </div>
            </div>
            
            {% if form.errors %}
              <div class="alert alert-danger mt-2">{{ form.errors }}</div>
            {% endif %}
          </div>
          {% endfor %}
        </div>

        <button type="button" id="add-pieza" class="btn btn-outline-success">
          Agregar otra pieza
        </button>
      </div>
    </div>

    <!-- Botón de envío -->
    <div class="text-center fade-in">
      <button type="submit" class="btn btn-primary btn-lg">
        Calcular Optimización
      </button>
      <a href="{% url 'opticut:historial' %}" class="btn btn-secondary btn-lg">
        Ver Historial
      </a>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('pieza-container');
    const addButton = document.getElementById('add-pieza');
    const totalFormsInput = document.querySelector('input[name$="-TOTAL_FORMS"]');
    
    let formCount = parseInt(totalFormsInput.value);

    // Función para actualizar números de piezas
    function actualizarNumeros() {
        document.querySelectorAll('.pieza-numero').forEach((elem, index) => {
            elem.textContent = index + 1;
        });
        
        // Mostrar/ocultar botones de eliminar
        const removeBtns = document.querySelectorAll('.remove-pieza');
        const totalPiezas = document.querySelectorAll('.pieza-form').length;
        removeBtns.forEach((btn, index) => {
            if (totalPiezas > 1) {
                btn.classList.remove('remove-pieza-hidden');
            } else {
                btn.classList.add('remove-pieza-hidden');
            }
        });
    }

    // Agregar nueva pieza
    addButton.addEventListener('click', function() {
        if (formCount >= 20) {
            alert('Máximo 20 piezas permitidas');
            return;
        }

        const template = container.children[0].cloneNode(true);
        
        // Limpiar valores
        template.querySelectorAll('input, select, textarea').forEach(input => {
            const name = input.name.replace(/-\d+-/, `-${formCount}-`);
            const id = input.id.replace(/-\d+-/, `-${formCount}-`);
            input.name = name;
            input.id = id;
            
            if (input.type !== 'hidden') {
                input.value = '';
                if (input.name.includes('cantidad')) {
                    input.value = '1';
                }
            }
        });

        container.appendChild(template);
        formCount++;
        totalFormsInput.value = formCount;
        actualizarNumeros();
    });

    // Eliminar pieza
    container.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-pieza') || e.target.closest('.remove-pieza')) {
            if (document.querySelectorAll('.pieza-form').length > 1) {
                e.target.closest('.pieza-form').remove();
                formCount--;
                totalFormsInput.value = formCount;
                actualizarNumeros();
            }
        }
    });

    actualizarNumeros();
});

// Función para actualizar labels según la unidad seleccionada
function actualizarLabelsUnidad() {
    const selector = document.getElementById('unidad_medida_selector');
    const unidad = selector.value;
    const unidadSpan = document.getElementById('unidad_ancho');
    const unidadAltoSpan = document.getElementById('unidad_alto');
    const unidadesPiezas = document.querySelectorAll('.unidad-pieza');
    
    const simbolos = {
        'cm': 'cm',
        'm': 'm',
        'in': 'in',
        'ft': 'ft'
    };
    
    const simbolo = simbolos[unidad] || 'cm';
    unidadSpan.textContent = `(${simbolo})`;
    unidadAltoSpan.textContent = `(${simbolo})`;
    
    // Actualizar unidades de piezas también
    unidadesPiezas.forEach(span => {
        span.textContent = `(${simbolo})`;
    });
    
    // Actualizar unidad del margen de corte - siempre muestra (mm)
    const unidadMargen = document.querySelector('.unidad-margen');
    if (unidadMargen) {
        unidadMargen.textContent = `(mm)`;
    }
}

// Ejecutar al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    actualizarLabelsUnidad();
    const selector = document.getElementById('unidad_medida_selector');
    if (selector) {
        selector.addEventListener('change', actualizarLabelsUnidad);
    }
    
    // Actualizar unidades cuando se agregan nuevas piezas
    const addButton = document.getElementById('add-pieza');
    if (addButton) {
        const originalAddHandler = addButton.onclick;
        addButton.addEventListener('click', function() {
            setTimeout(actualizarLabelsUnidad, 100);
        });
    }
});
</script>
{% endblock %}