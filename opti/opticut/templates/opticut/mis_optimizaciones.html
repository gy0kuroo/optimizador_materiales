{% extends 'opticut/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'opticut/css/mis_optimizaciones.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="text-center mb-4 fade-in">üìã Mis Optimizaciones Guardadas</h2>

  <!-- Filtros y B√∫squeda -->
  <div class="search-filters fade-in">
    <h5 class="mb-3">üîç Buscar y Filtrar</h5>
    <form method="GET" action="{% url 'opticut:mis_optimizaciones' %}" id="filtros-form">
      <div class="row">
        <div class="col-md-3 mb-3">
          <label for="nombre_pieza" class="form-label">Nombre de Pieza</label>
          <input type="text" 
                 class="form-control" 
                 id="nombre_pieza" 
                 name="nombre_pieza" 
                 placeholder="Ej: Puerta, Caj√≥n, Estante..."
                 value="{{ nombre_pieza }}">
        </div>
        <div class="col-md-2 mb-3">
          <label for="fecha_desde" class="form-label">Fecha Desde</label>
          <input type="date" 
                 class="form-control" 
                 id="fecha_desde" 
                 name="fecha_desde" 
                 value="{{ fecha_desde }}">
        </div>
        <div class="col-md-2 mb-3">
          <label for="fecha_hasta" class="form-label">Fecha Hasta</label>
          <input type="date" 
                 class="form-control" 
                 id="fecha_hasta" 
                 name="fecha_hasta" 
                 value="{{ fecha_hasta }}">
        </div>
        <div class="col-md-2 mb-3">
          <label for="ordenar_por" class="form-label">Ordenar por</label>
          <select class="form-control" id="ordenar_por" name="ordenar_por">
            <option value="fecha_desc" {% if ordenar_por == 'fecha_desc' %}selected{% endif %}>Fecha (M√°s recientes )</option>
            <option value="fecha_asc" {% if ordenar_por == 'fecha_asc' %}selected{% endif %}>Fecha (M√°s antiguas )</option>
            <option value="aprovechamiento_desc" {% if ordenar_por == 'aprovechamiento_desc' %}selected{% endif %}>Aprovechamiento (Mayor a menor)</option>
            <option value="aprovechamiento_asc" {% if ordenar_por == 'aprovechamiento_asc' %}selected{% endif %}>Aprovechamiento (Menor a mayor)</option>
          </select>
        </div>
        <div class="col-md-2 mb-3 d-flex align-items-end">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="solo_favoritos" name="solo_favoritos" value="true" {% if solo_favoritos == 'true' %}checked{% endif %}>
            <label class="form-check-label" for="solo_favoritos">
              ‚≠ê Solo Favoritos
            </label>
          </div>
        </div>
        <div class="col-md-2 mb-3 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">üîç Buscar</button>
        </div>
      </div>
      {% if nombre_pieza or fecha_desde or fecha_hasta %}
      <div class="mt-2">
        <a href="{% url 'opticut:mis_optimizaciones' %}?ordenar_por={{ ordenar_por }}" class="btn btn-sm btn-outline-secondary">
          üóëÔ∏è Limpiar Filtros
        </a>
        {% if nombre_pieza %}
          <span class="filter-badge">Pieza: {{ nombre_pieza }}</span>
        {% endif %}
        {% if fecha_desde %}
          <span class="filter-badge">Desde: {{ fecha_desde }}</span>
        {% endif %}
        {% if fecha_hasta %}
          <span class="filter-badge">Hasta: {{ fecha_hasta }}</span>
        {% endif %}
      </div>
      {% endif %}
    </form>
  </div>

  <!-- Bot√≥n Borrar Historial -->
  <div class="text-end mb-3 fade-in">
    <form method="POST" action="{% url 'opticut:borrar_historial' %}" class="d-inline">
      {% csrf_token %}
      <button type="submit" 
              class="btn btn-danger" 
              onclick="return confirm('¬øSeguro que deseas borrar todo tu historial? Esta acci√≥n no se puede deshacer.')">
        üóëÔ∏è Borrar Todo el Historial
      </button>
    </form>
  </div>

  <!-- Lista de Optimizaciones -->
  {% if optimizaciones_con_piezas %}
    <div class="row">
      {% for item in optimizaciones_con_piezas %}
        {% with optimizacion=item.optimizacion piezas=item.piezas %}
        <div class="col-md-6 col-lg-4 mb-4 fade-in">
          <div class="optimizacion-card">
            {% if optimizacion.imagen %}
              <div class="chart-container chart-container-clickable" 
                   onclick="abrirModalImagen('{{ optimizacion.imagen.url }}', {{ optimizacion.id }})">
                <img src="{{ optimizacion.imagen.url }}" 
                     class="card-img-top chart-thumbnail" 
                     alt="Optimizaci√≥n #{{ optimizacion.id }}">
                <div class="chart-overlay">
                  <span class="chart-hint">üîç Click para ver en pantalla completa</span>
                </div>
              </div>
            {% endif %}
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="card-title mb-0">Optimizaci√≥n #{{ item.numero }}</h5>
                <button type="button" 
                        class="btn btn-sm p-0 border-0 bg-transparent favorito-btn align-self-center" 
                        data-optimizacion-id="{{ optimizacion.id }}"
                        data-favorito-url="{% url 'opticut:toggle_favorito' optimizacion.id %}"
                        data-favorito="{{ optimizacion.favorito|yesno:'true,false' }}"
                        title="{% if optimizacion.favorito %}Quitar de favoritos{% else %}Marcar como favorito{% endif %}"
                        class="favorito-btn-inline">
                  {% if optimizacion.favorito %}
                    <span class="favorito-icon favorito-icon-active">‚≠ê</span>
                  {% else %}
                    <span class="favorito-icon favorito-icon-inactive">‚òÜ</span>
                  {% endif %}
                </button>
              </div>
              <p class="card-text">
                <strong>üìÖ Fecha:</strong> {{ optimizacion.fecha|date:"d/m/Y" }}<br>
                <strong>üïê Hora:</strong> {{ optimizacion.fecha|date:"H:i" }} (Chile)<br>
                <strong>üìê Tablero:</strong> {{ item.ancho_mostrar }} √ó {{ item.alto_mostrar }} {{ item.unidad_medida }}<br>
                <strong>üìä Aprovechamiento:</strong> 
                <span class="badge bg-success">{{ optimizacion.aprovechamiento_total|floatformat:2 }}%</span>
              </p>
              
              <!-- Lista de piezas -->
              {% if piezas %}
              <details class="mb-2">
                <summary class="piezas-summary">
                  üì¶ Ver Piezas ({{ piezas|length }})
                </summary>
                <div class="mt-2 piezas-details">
                  {% for pieza in piezas %}
                    <div>‚Ä¢ <strong>{{ pieza.nombre }}</strong>: {{ pieza.ancho }}√ó{{ pieza.alto }}cm (x{{ pieza.cantidad }})</div>
                  {% endfor %}
                </div>
              </details>
              {% endif %}
              
              <div class="action-buttons mt-3 d-flex gap-2 align-items-center">
                <!-- Botones principales -->
                <a href="{% url 'opticut:descargar_pdf' optimizacion.id %}?ordenar_por={{ ordenar_por }}" 
                   class="btn-action btn-pdf flex-fill"
                   title="Descargar PDF completo">
                  <span class="icon"></span> üìÑ PDF
                </a>
                <a href="{% url 'opticut:duplicar_optimizacion' optimizacion.id %}?ordenar_por={{ ordenar_por }}{% if solo_favoritos == 'true' %}&solo_favoritos=true{% endif %}{% if nombre_pieza %}&nombre_pieza={{ nombre_pieza }}{% endif %}" 
                   class="btn-action btn-duplicar flex-fill" 
                   title="Duplicar esta optimizaci√≥n">
                  <span class="icon"></span> üìã Duplicar
                </a>
                
                <!-- Men√∫ desplegable para acciones secundarias -->
                <div class="dropdown">
                  <button class="btn btn-action btn-mas-opciones flex-fill" 
                          type="button" 
                          id="dropdownMenuButton{{ optimizacion.id }}" 
                          data-bs-toggle="dropdown" 
                          aria-expanded="false"
                          title="M√°s opciones">
                    <span class="icon">‚öôÔ∏è</span> M√°s opciones
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton{{ optimizacion.id }}">
                    <li>
                      <a class="dropdown-item" href="{% url 'opticut:descargar_png' optimizacion.id %}">
                        üì• Descargar PNG
                      </a>
                    </li>
                    <li>
                      <a class="dropdown-item" href="{% url 'opticut:calcular_tiempo_corte' optimizacion.id %}">
                        ‚è±Ô∏è Calcular Tiempo
                      </a>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                      <form method="post" 
                            action="{% url 'opticut:borrar_optimizacion' optimizacion.id %}" 
                         class="delete-form-inline" 
                         onsubmit="return confirm('¬øEliminar esta optimizaci√≥n?');">
                       {% csrf_token %}
                       <button type="submit" class="dropdown-item text-danger delete-button">
                          üóëÔ∏è Eliminar
                        </button>
                      </form>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endwith %}
      {% endfor %}
    </div>
    
    <!-- Contador de resultados -->
    <div class="text-center mt-4 mb-4">
      <p class="text-muted">
        Mostrando <strong>{{ optimizaciones_con_piezas|length }}</strong> optimizaci√≥n{{ optimizaciones_con_piezas|length|pluralize:"es" }}
      </p>
    </div>
  {% else %}
    <div class="card fade-in text-center card-empty-state">
      <h4 class="text-muted mb-3">üì≠ No hay optimizaciones</h4>
      <p class="text-muted mb-4">
        {% if nombre_pieza or fecha_desde or fecha_hasta %}
          No se encontraron optimizaciones con los filtros aplicados.
          <a href="{% url 'opticut:mis_optimizaciones' %}">Ver todas las optimizaciones</a>
        {% else %}
          A√∫n no tienes optimizaciones guardadas.
        {% endif %}
      </p>
      <a href="{% url 'opticut:index' %}" class="btn btn-primary">
        ‚ûï Crear Nueva Optimizaci√≥n
      </a>
    </div>
  {% endif %}
</div>

    <!-- Modal para im√°genes en pantalla completa -->
    <div class="modal fade" id="modalImagen" tabindex="-1" aria-labelledby="modalImagenLabel" aria-hidden="true">
      <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
          <div class="modal-header bg-dark text-white">
            <h5 class="modal-title" id="modalImagenLabel">Tablero en Pantalla Completa</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center modal-grafico-body">
            <div class="row h-100">
              <div class="col-10">
                <div id="modalImagenContenido" class="modal-grafico-contenido">
                  <!-- La imagen se cargar√° aqu√≠ -->
                </div>
              </div>
              <div class="col-2 d-flex flex-column justify-content-center align-items-center zoom-controls">
                <label for="zoomSliderImagen" class="text-white mb-2 zoom-label">Zoom</label>
                <input type="range" 
                       class="form-range zoom-slider" 
                       id="zoomSliderImagen" 
                       min="50" 
                       max="300" 
                       value="100" 
                       step="5">
                <span id="zoomValueImagen" class="text-white mt-2 zoom-value">100%</span>
              </div>
            </div>
          </div>
          <div class="modal-footer bg-dark text-white">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            <button type="button" class="btn btn-primary" onclick="resetearZoomImagen()">üîç Resetear Zoom</button>
          </div>
        </div>
      </div>
    </div>

<script>
function abrirModalImagen(urlImagen, optimizacionId) {
    const modal = new bootstrap.Modal(document.getElementById('modalImagen'));
    const contenido = document.getElementById('modalImagenContenido');
    const titulo = document.getElementById('modalImagenLabel');
    
    // Limpiar contenido anterior
    contenido.innerHTML = '';
    
    // Establecer t√≠tulo
    titulo.textContent = `Tablero - Optimizaci√≥n #${optimizacionId} - Pantalla Completa`;
    
    // Crear contenedor para la imagen con capacidad de arrastre
    const contenedorImagen = document.createElement('div');
    contenedorImagen.style.position = 'relative';
    contenedorImagen.style.overflow = 'hidden';
    contenedorImagen.style.width = '100%';
    contenedorImagen.style.height = '100%';
    contenedorImagen.style.cursor = 'grab';
    
    // Crear imagen
    const img = document.createElement('img');
    img.src = urlImagen;
    img.alt = `Optimizaci√≥n #${optimizacionId}`;
    img.className = 'img-fluid';
    // Ajustar tama√±o inicial para que se vea completo sin zoom excesivo
    // La imagen se ajustar√° autom√°ticamente al contenedor
    img.style.maxWidth = '100%';
    img.style.maxHeight = '90vh';
    img.style.width = 'auto';
    img.style.height = 'auto';
    img.style.display = 'block';
    img.style.margin = '0 auto';
    img.style.transition = 'transform 0.1s ease-out';
    img.style.userSelect = 'none';
    img.draggable = false;
    img.style.objectFit = 'contain';
    // Asegurar que no haya transformaci√≥n inicial
    img.style.transform = 'scale(1) translate(0px, 0px)';
    
    // Variables para zoom y arrastre
    let zoomLevel = 1; // Valor del zoom (1.0 = 100%)
    let isDragging = false;
    let startX = 0;
    let startY = 0;
    let translateX = 0;
    let translateY = 0;
    let currentTranslateX = 0;
    let currentTranslateY = 0;
    
    // Esperar a que la imagen cargue para inicializar correctamente
    img.onload = function() {
        // Resetear transformaci√≥n inicial
        img.style.transform = 'scale(1) translate(0px, 0px)';
        translateX = 0;
        translateY = 0;
        currentTranslateX = 0;
        currentTranslateY = 0;
    };
    
    // Funci√≥n para actualizar el zoom basado en el slider
    const actualizarZoom = (zoomPercent) => {
        zoomLevel = zoomPercent / 100; // Convertir porcentaje a escala (50% = 0.5, 100% = 1.0, 300% = 3.0)
        img.style.transform = `scale(${zoomLevel}) translate(${translateX}px, ${translateY}px)`;
        img.style.transformOrigin = 'center center';
        
        // Actualizar cursor seg√∫n el zoom
        if (zoomLevel > 1) {
            img.style.cursor = 'grab';
            contenedorImagen.style.cursor = 'grab';
        } else {
            img.style.cursor = 'default';
            contenedorImagen.style.cursor = 'default';
        }
        
        // Actualizar el valor mostrado
        document.getElementById('zoomValueImagen').textContent = zoomPercent + '%';
    };
    
    // Configurar el slider de zoom
    const zoomSlider = document.getElementById('zoomSliderImagen');
    zoomSlider.addEventListener('input', function(e) {
        const zoomPercent = parseInt(e.target.value);
        actualizarZoom(zoomPercent);
    });
    
    // Funcionalidad de arrastre cuando est√° en zoom
    img.addEventListener('mousedown', function(e) {
        if (zoomLevel > 1) {
            // Cuando est√° en zoom, permitir arrastre
            e.preventDefault();
            isDragging = true;
            startX = e.clientX - currentTranslateX;
            startY = e.clientY - currentTranslateY;
            this.style.cursor = 'grabbing';
            contenedorImagen.style.cursor = 'grabbing';
        }
    });
    
    img.addEventListener('mousemove', function(e) {
        if (isDragging && zoomLevel > 1) {
            e.preventDefault();
            currentTranslateX = e.clientX - startX;
            currentTranslateY = e.clientY - startY;
            translateX = currentTranslateX;
            translateY = currentTranslateY;
            this.style.transform = `scale(${zoomLevel}) translate(${translateX}px, ${translateY}px)`;
        }
    });
    
    img.addEventListener('mouseup', function(e) {
        if (isDragging) {
            isDragging = false;
            if (zoomLevel > 1) {
                this.style.cursor = 'grab';
                contenedorImagen.style.cursor = 'grab';
            } else {
                this.style.cursor = 'default';
                contenedorImagen.style.cursor = 'default';
            }
        }
    });
    
    img.addEventListener('mouseleave', function(e) {
        if (isDragging) {
            isDragging = false;
            if (zoomLevel > 1) {
                this.style.cursor = 'grab';
                contenedorImagen.style.cursor = 'grab';
            }
        }
    });
    
    // Prevenir men√∫ contextual al hacer click derecho cuando est√° en zoom
    img.addEventListener('contextmenu', function(e) {
        if (zoomLevel > 1) {
            e.preventDefault();
        }
    });
    
    // Soporte para touch (m√≥viles)
    let touchStartX = 0;
    let touchStartY = 0;
    let touchCurrentX = 0;
    let touchCurrentY = 0;
    let isTouchDragging = false;
    
    img.addEventListener('touchstart', function(e) {
        if (zoomLevel > 1) {
            e.preventDefault();
            isTouchDragging = true;
            touchStartX = e.touches[0].clientX - currentTranslateX;
            touchStartY = e.touches[0].clientY - currentTranslateY;
        }
    });
    
    img.addEventListener('touchmove', function(e) {
        if (isTouchDragging && zoomLevel > 1) {
            e.preventDefault();
            touchCurrentX = e.touches[0].clientX - touchStartX;
            touchCurrentY = e.touches[0].clientY - touchStartY;
            translateX = touchCurrentX;
            translateY = touchCurrentY;
            currentTranslateX = touchCurrentX;
            currentTranslateY = touchCurrentY;
            this.style.transform = `scale(${zoomLevel}) translate(${translateX}px, ${translateY}px)`;
        }
    });
    
    img.addEventListener('touchend', function(e) {
        isTouchDragging = false;
    });
    
    contenedorImagen.appendChild(img);
    contenido.appendChild(contenedorImagen);
    modal.show();
}

function resetearZoomImagen() {
    const img = document.querySelector('#modalImagenContenido img');
    const zoomSlider = document.getElementById('zoomSliderImagen');
    if (img && zoomSlider) {
        // Resetear slider a 100%
        zoomSlider.value = 100;
        // Resetear transformaci√≥n visual
        img.style.transform = 'scale(1) translate(0px, 0px)';
        img.style.cursor = 'default';
        // Actualizar el valor mostrado
        document.getElementById('zoomValueImagen').textContent = '100%';
        // Resetear variables de arrastre si est√°n definidas
        if (window.currentTranslateX !== undefined) {
            window.currentTranslateX = 0;
            window.currentTranslateY = 0;
        }
    }
}

// Funci√≥n para obtener el token CSRF de las cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Funcionalidad AJAX para favoritos
document.addEventListener('DOMContentLoaded', function() {
    const favoritoButtons = document.querySelectorAll('.favorito-btn');
    
    favoritoButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const optimizacionId = this.getAttribute('data-optimizacion-id');
            const favoritoUrl = this.getAttribute('data-favorito-url');
            const icon = this.querySelector('.favorito-icon');
            const buttonElement = this;
            
            // Deshabilitar el bot√≥n mientras se procesa
            buttonElement.disabled = true;
            buttonElement.style.opacity = '0.6';
            
            // Obtener token CSRF
            const csrftoken = getCookie('csrftoken');
            
            // Crear FormData para enviar el CSRF token
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', csrftoken);
            
            // Hacer petici√≥n AJAX usando la URL del atributo data
            const url = favoritoUrl + '?ajax=true';
            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrftoken
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Actualizar el estado visual
                    if (data.favorito) {
                        icon.textContent = '‚≠ê';
                        icon.style.color = '#ffc107';
                        buttonElement.setAttribute('data-favorito', 'true');
                        buttonElement.setAttribute('title', 'Quitar de favoritos');
                    } else {
                        icon.textContent = '‚òÜ';
                        icon.style.color = '#ccc';
                        buttonElement.setAttribute('data-favorito', 'false');
                        buttonElement.setAttribute('title', 'Marcar como favorito');
                    }
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al actualizar favorito. Por favor, recarga la p√°gina.');
            })
            .finally(() => {
                // Rehabilitar el bot√≥n
                buttonElement.disabled = false;
                buttonElement.style.opacity = '1';
            });
        });
    });
});
</script>

{% endblock %}
