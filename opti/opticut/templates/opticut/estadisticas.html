{% extends 'opticut/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <h2 class="text-center mb-4 fade-in">üìä Estad√≠sticas y An√°lisis</h2>
  
  <!-- Selector de Per√≠odo -->
  <div class="card mb-4 fade-in">
    <div class="card-body">
      <h5 class="card-title mb-3">üìÖ Seleccionar Per√≠odo</h5>
      <form method="GET" action="{% url 'opticut:estadisticas' %}" class="d-flex gap-2">
        <select name="periodo" class="form-select" onchange="this.form.submit()">
          <option value="todos" {% if periodo == 'todos' %}selected{% endif %}>Todos los tiempos</option>
          <option value="semanal" {% if periodo == 'semanal' %}selected{% endif %}>√öltima semana</option>
          <option value="mensual" {% if periodo == 'mensual' %}selected{% endif %}>√öltimo mes</option>
          <option value="anual" {% if periodo == 'anual' %}selected{% endif %}>√öltimo a√±o</option>
        </select>
        <button type="submit" class="btn btn-primary">üîç Actualizar</button>
      </form>
    </div>
  </div>
  
  {% if total_optimizaciones > 0 %}
    <!-- Resumen de Estad√≠sticas -->
    <div class="row mb-4 fade-in">
      <div class="col-md-3 mb-3">
        <div class="card text-center bg-primary text-white stats-card">
          <div class="card-body">
            <h5 class="card-title stats-title">Total Optimizaciones</h5>
            <h2>{{ total_optimizaciones }}</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card text-center bg-success text-white stats-card">
          <div class="card-body">
            <h5 class="card-title stats-title">Aprovechamiento Promedio</h5>
            <h2>{{ promedio_aprovechamiento }}%</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card text-center bg-info text-white stats-card">
          <div class="card-body">
            <h5 class="card-title stats-title">Mejor Aprovechamiento</h5>
            <h2>{{ max_aprovechamiento }}%</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card text-center bg-warning text-white stats-card">
          <div class="card-body">
            <h5 class="card-title stats-title">Desperdicio Promedio</h5>
            <h2>{{ promedio_desperdicio }}%</h2>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Gr√°ficos -->
    <div class="row mb-4 fade-in">
      <div class="col-md-6 mb-4">
        <div class="card">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0">üìä Gr√°fico de Aprovechamiento</h5>
          </div>
          <div class="card-body">
            {% if grafico_aprovechamiento %}
              <div class="chart-container" style="position: relative; cursor: pointer;" 
                   onclick="abrirModalGrafico('aprovechamiento')">
                <img src="data:image/png;base64,{{ grafico_aprovechamiento }}" 
                     alt="Gr√°fico de Aprovechamiento" 
                     class="img-fluid chart-thumbnail">
                <div class="chart-overlay">
                  <span class="chart-hint">üîç Click para ver en pantalla completa</span>
                </div>
              </div>
            {% else %}
              <p class="text-muted">No hay datos para mostrar</p>
            {% endif %}
          </div>
        </div>
      </div>
      
      <div class="col-md-6 mb-4">
        <div class="card">
          <div class="card-header bg-danger text-white">
            <h5 class="mb-0">üìâ Gr√°fico de Desperdicio</h5>
          </div>
          <div class="card-body">
            {% if grafico_desperdicio %}
              <div class="chart-container" style="position: relative; cursor: pointer;" 
                   onclick="abrirModalGrafico('desperdicio')">
                <img src="data:image/png;base64,{{ grafico_desperdicio }}" 
                     alt="Gr√°fico de Desperdicio" 
                     class="img-fluid chart-thumbnail">
                <div class="chart-overlay">
                  <span class="chart-hint">üîç Click para ver en pantalla completa</span>
                </div>
              </div>
            {% else %}
              <p class="text-muted">No hay datos para mostrar</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    
    <!-- Modal para gr√°ficos en pantalla completa -->
    <div class="modal fade" id="modalGrafico" tabindex="-1" aria-labelledby="modalGraficoLabel" aria-hidden="true">
      <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
          <div class="modal-header bg-dark text-white">
            <h5 class="modal-title" id="modalGraficoLabel">Gr√°fico en Pantalla Completa</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center modal-grafico-body">
            <div class="row h-100">
              <div class="col-10">
                <div id="modalGraficoContenido" class="modal-grafico-contenido">
                  <!-- El gr√°fico en alta resoluci√≥n se cargar√° aqu√≠ -->
                </div>
              </div>
              <div class="col-2 d-flex flex-column justify-content-center align-items-center zoom-controls">
                <label for="zoomSlider" class="text-white mb-2" style="writing-mode: vertical-rl; text-orientation: mixed; font-size: 0.9rem;">Zoom</label>
                <input type="range" 
                       class="form-range" 
                       id="zoomSlider" 
                       min="50" 
                       max="300" 
                       value="100" 
                       step="5"
                       style="width: 200px; transform: rotate(-90deg); margin: 50px 0;">
                <span id="zoomValue" class="text-white mt-2" style="font-size: 0.85rem;">100%</span>
              </div>
            </div>
          </div>
          <div class="modal-footer bg-dark text-white">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            <button type="button" class="btn btn-primary" onclick="resetearZoom()">üîç Resetear Zoom</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Top Optimizaciones -->
    <div class="card fade-in">
      <div class="card-header bg-dark text-white">
        <h5 class="mb-0">üèÜ Top 10 Mejores Optimizaciones</h5>
      </div>
      <div class="card-body">
        {% if top_optimizaciones %}
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th>#</th>
                  <th>Fecha</th>
                  <th>Aprovechamiento</th>
                  <th>Tablero</th>
                  <th>Piezas</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for item in top_optimizaciones %}
                  <tr>
                    <td><strong>{{ item.posicion }}</strong></td>
                    <td>{{ item.optimizacion.fecha|date:"d/m/Y H:i" }}</td>
                    <td>
                      <span class="badge bg-success">{{ item.optimizacion.aprovechamiento_total|floatformat:2 }}%</span>
                    </td>
                    <td>{{ item.optimizacion.ancho_tablero }} √ó {{ item.optimizacion.alto_tablero }} cm</td>
                    <td>
                      <details>
                        <summary style="cursor: pointer; color: #007bff;">Ver ({{ item.piezas|length }})</summary>
                        <div class="mt-2" style="font-size: 0.85rem;">
                          {% for pieza in item.piezas %}
                            <div>‚Ä¢ <strong>{{ pieza.nombre }}</strong>: {{ pieza.ancho }}√ó{{ pieza.alto }}cm (x{{ pieza.cantidad }})</div>
                          {% endfor %}
                        </div>
                      </details>
                    </td>
                    <td>
                      <a href="{% url 'opticut:duplicar_optimizacion' item.optimizacion.id %}" 
                         class="btn btn-sm btn-primary" title="Duplicar">
                        üìã
                      </a>
                      <a href="{% url 'opticut:descargar_pdf' item.optimizacion.id %}" 
                         class="btn btn-sm btn-success" title="PDF">
                        üìÑ
                      </a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted">No hay optimizaciones para mostrar</p>
        {% endif %}
      </div>
    </div>
    
  {% else %}
    <div class="card fade-in text-center" style="padding: 3rem;">
      <h4 class="text-muted mb-3">üì≠ No hay datos</h4>
      <p class="text-muted mb-4">
        {% if periodo != 'todos' %}
          No hay optimizaciones en el per√≠odo seleccionado.
          <a href="{% url 'opticut:estadisticas' %}?periodo=todos">Ver todas las optimizaciones</a>
        {% else %}
          A√∫n no tienes optimizaciones guardadas para mostrar estad√≠sticas.
        {% endif %}
      </p>
      <a href="{% url 'opticut:index' %}" class="btn btn-primary">
        ‚ûï Crear Nueva Optimizaci√≥n
      </a>
    </div>
  {% endif %}
  
  <!-- Bot√≥n para volver -->
  <div class="text-center mt-4 mb-5 fade-in">
    <a href="{% url 'opticut:index' %}" class="btn btn-secondary btn-lg me-2">
      ‚Üê Volver al Optimizador
    </a>
    <a href="{% url 'opticut:mis_optimizaciones' %}" class="btn btn-info btn-lg">
      üìã Ver Historial
    </a>
  </div>
</div>

<style>
.badge {
    padding: 0.35em 0.65em;
    border-radius: 6px;
    font-weight: 600;
}

details summary {
    user-select: none;
}

details summary::-webkit-details-marker {
    display: none;
}

.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: none;
    margin-bottom: 1rem;
}

.fade-in {
    animation: fadeIn 0.5s;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Estilos para tarjetas de estad√≠sticas */
.stats-card {
    min-height: 140px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.stats-card .card-body {
    padding: 1.5rem;
    width: 100%;
}

.stats-title {
    font-size: 0.95rem;
    line-height: 1.3;
    margin-bottom: 0.75rem;
    word-wrap: break-word;
    white-space: normal;
    height: auto;
    min-height: 2.6em;
}

.stats-card h2 {
    font-size: 2rem;
    margin: 0;
}

/* Estilos para gr√°ficos clicables */
.chart-container {
    position: relative;
    transition: transform 0.2s;
}

.chart-container:hover {
    transform: scale(1.02);
}

.chart-thumbnail {
    width: 100%;
    height: auto;
    display: block;
}

.chart-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s;
}

.chart-container:hover .chart-overlay {
    opacity: 1;
}

.chart-hint {
    color: white;
    font-weight: bold;
    font-size: 1.1rem;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
}

/* Estilos para modal de gr√°fico */
.modal-grafico-body {
    background-color: #f8f9fa;
    overflow: hidden;
    padding: 0;
    min-height: calc(100vh - 120px);
}

.modal-grafico-body .row {
    height: 100%;
    margin: 0;
}

.modal-grafico-body .col-11 {
    overflow: auto;
    padding: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
}

.zoom-controls {
    background: linear-gradient(180deg, rgba(33, 37, 41, 0.95) 0%, rgba(52, 58, 64, 0.95) 100%);
    padding: 1rem 0.5rem;
    border-left: 2px solid rgba(0, 123, 255, 0.5);
    min-width: 100px;
    box-shadow: -2px 0 10px rgba(0, 0, 0, 0.2);
}

.zoom-controls input[type="range"] {
    cursor: pointer;
    width: 300px;
    height: 8px;
    margin: 80px 0;
}

.zoom-controls label {
    font-weight: bold;
    margin-bottom: 1rem;
}

.zoom-controls #zoomValue {
    font-weight: bold;
    font-size: 1rem;
    margin-top: 1rem;
}

.modal-grafico-contenido {
    display: inline-block;
    max-width: 100%;
    padding: 2rem;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    position: relative;
    overflow: visible;
}

#modalGraficoContenido {
    width: 100%;
    text-align: center;
    position: relative;
}

#modalGraficoContenido > div {
    width: 100%;
    min-height: 400px;
    display: flex;
    align-items: center;
    justify-content: center;
}

#modalGraficoContenido img {
    max-width: 100%;
    height: auto;
    cursor: grab;
    transition: transform 0.2s ease-out;
    display: block;
    margin: 0 auto;
    user-select: none;
    -webkit-user-drag: none;
    touch-action: none;
}

#modalGraficoContenido img:active {
    cursor: grabbing;
}

@media (max-width: 768px) {
    .stats-title {
        font-size: 0.85rem;
    }
    
    .stats-card h2 {
        font-size: 1.5rem;
    }
}
</style>

<script>
// Datos de gr√°ficos en alta resoluci√≥n
const graficosHD = {
    aprovechamiento: {% if grafico_aprovechamiento_hd %}'data:image/png;base64,{{ grafico_aprovechamiento_hd }}'{% else %}null{% endif %},
    desperdicio: {% if grafico_desperdicio_hd %}'data:image/png;base64,{{ grafico_desperdicio_hd }}'{% else %}null{% endif %}
};

function abrirModalGrafico(tipo) {
    const modal = new bootstrap.Modal(document.getElementById('modalGrafico'));
    const contenido = document.getElementById('modalGraficoContenido');
    const titulo = document.getElementById('modalGraficoLabel');
    
    // Limpiar contenido anterior
    contenido.innerHTML = '';
    
    // Establecer t√≠tulo
    if (tipo === 'aprovechamiento') {
        titulo.textContent = 'üìä Gr√°fico de Aprovechamiento - Pantalla Completa';
    } else {
        titulo.textContent = 'üìâ Gr√°fico de Desperdicio - Pantalla Completa';
    }
    
    // Crear contenedor para el gr√°fico con capacidad de arrastre
    const contenedorGrafico = document.createElement('div');
    contenedorGrafico.style.position = 'relative';
    contenedorGrafico.style.overflow = 'hidden';
    contenedorGrafico.style.width = '100%';
    contenedorGrafico.style.height = '100%';
    contenedorGrafico.style.cursor = 'grab';
    
    // Crear imagen en alta resoluci√≥n
    const img = document.createElement('img');
    img.src = graficosHD[tipo];
    img.alt = tipo === 'aprovechamiento' ? 'Gr√°fico de Aprovechamiento' : 'Gr√°fico de Desperdicio';
    img.className = 'img-fluid';
    // Mostrar inicialmente al 70% para que se vea completo y permita zoom
    img.style.maxWidth = '70%';
    img.style.height = 'auto';
    img.style.display = 'block';
    img.style.margin = '0 auto';
    img.style.transition = 'transform 0.1s ease-out';
    img.style.userSelect = 'none';
    img.draggable = false;
    
    // Variables para zoom y arrastre
    let zoomLevel = 1; // Valor del zoom (1.0 = 100%)
    let isDragging = false;
    let startX = 0;
    let startY = 0;
    let translateX = 0;
    let translateY = 0;
    let currentTranslateX = 0;
    let currentTranslateY = 0;
    
    // Funci√≥n para actualizar el zoom basado en el slider
    const actualizarZoom = (zoomPercent) => {
        zoomLevel = zoomPercent / 100; // Convertir porcentaje a escala (50% = 0.5, 100% = 1.0, 300% = 3.0)
        img.style.transform = `scale(${zoomLevel}) translate(${translateX}px, ${translateY}px)`;
        img.style.transformOrigin = 'center center';
        
        // Actualizar cursor seg√∫n el zoom
        if (zoomLevel > 1) {
            img.style.cursor = 'grab';
            contenedorGrafico.style.cursor = 'grab';
        } else {
            img.style.cursor = 'default';
            contenedorGrafico.style.cursor = 'default';
        }
        
        // Actualizar el valor mostrado
        document.getElementById('zoomValue').textContent = zoomPercent + '%';
    };
    
    // Configurar el slider de zoom
    const zoomSlider = document.getElementById('zoomSlider');
    zoomSlider.addEventListener('input', function(e) {
        const zoomPercent = parseInt(e.target.value);
        actualizarZoom(zoomPercent);
    });
    
    // Funcionalidad de arrastre cuando est√° en zoom
    img.addEventListener('mousedown', function(e) {
        if (zoomLevel > 1) {
            // Cuando est√° en zoom, permitir arrastre
            e.preventDefault();
            isDragging = true;
            startX = e.clientX - currentTranslateX;
            startY = e.clientY - currentTranslateY;
            this.style.cursor = 'grabbing';
            contenedorGrafico.style.cursor = 'grabbing';
        }
    });
    
    img.addEventListener('mousemove', function(e) {
        if (isDragging && zoomLevel > 1) {
            e.preventDefault();
            currentTranslateX = e.clientX - startX;
            currentTranslateY = e.clientY - startY;
            translateX = currentTranslateX;
            translateY = currentTranslateY;
            this.style.transform = `scale(${zoomLevel}) translate(${translateX}px, ${translateY}px)`;
        }
    });
    
    img.addEventListener('mouseup', function(e) {
        if (isDragging) {
            isDragging = false;
            if (zoomLevel > 1) {
                this.style.cursor = 'grab';
                contenedorGrafico.style.cursor = 'grab';
            } else {
                this.style.cursor = 'default';
                contenedorGrafico.style.cursor = 'default';
            }
        }
    });
    
    img.addEventListener('mouseleave', function(e) {
        if (isDragging) {
            isDragging = false;
            if (zoomLevel > 1) {
                this.style.cursor = 'grab';
                contenedorGrafico.style.cursor = 'grab';
            }
        }
    });
    
    // Prevenir men√∫ contextual al hacer click derecho cuando est√° en zoom
    img.addEventListener('contextmenu', function(e) {
        if (zoomLevel > 1) {
            e.preventDefault();
        }
    });
    
    // Soporte para touch (m√≥viles)
    let touchStartX = 0;
    let touchStartY = 0;
    let touchCurrentX = 0;
    let touchCurrentY = 0;
    let isTouchDragging = false;
    
    img.addEventListener('touchstart', function(e) {
        if (zoomLevel > 1) {
            e.preventDefault();
            isTouchDragging = true;
            touchStartX = e.touches[0].clientX - currentTranslateX;
            touchStartY = e.touches[0].clientY - currentTranslateY;
        }
    });
    
    img.addEventListener('touchmove', function(e) {
        if (isTouchDragging && zoomLevel > 1) {
            e.preventDefault();
            touchCurrentX = e.touches[0].clientX - touchStartX;
            touchCurrentY = e.touches[0].clientY - touchStartY;
            translateX = touchCurrentX;
            translateY = touchCurrentY;
            currentTranslateX = touchCurrentX;
            currentTranslateY = touchCurrentY;
            this.style.transform = `scale(${zoomLevel}) translate(${translateX}px, ${translateY}px)`;
        }
    });
    
    img.addEventListener('touchend', function(e) {
        isTouchDragging = false;
    });
    
    contenedorGrafico.appendChild(img);
    contenido.appendChild(contenedorGrafico);
    modal.show();
}

function resetearZoom() {
    const img = document.querySelector('#modalGraficoContenido img');
    const zoomSlider = document.getElementById('zoomSlider');
    if (img && zoomSlider) {
        // Resetear slider a 100%
        zoomSlider.value = 100;
        // Resetear transformaci√≥n visual
        img.style.transform = 'scale(1) translate(0px, 0px)';
        img.style.cursor = 'default';
        // Actualizar el valor mostrado
        document.getElementById('zoomValue').textContent = '100%';
    }
}
</script>
{% endblock %}

