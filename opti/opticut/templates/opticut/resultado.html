{% extends 'opticut/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'opticut/css/resultado.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="text-center fade-in">Resultado del Plan de Corte</h2>
  
  <!-- Resumen general -->
  <div class="row mt-4 fade-in">
    <div class="col-md-4">
      <div class="card text-center 
           {% if optimizacion.aprovechamiento_total < 30 %}bg-danger text-white
           {% elif optimizacion.aprovechamiento_total < 60 %}bg-warning text-white
           {% else %}bg-success text-white{% endif %}">
        <div class="card-body">
          <h5 class="card-title">Aprovechamiento</h5>
          <h2>{{ optimizacion.aprovechamiento_total|floatformat:2 }}%</h2>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-center bg-info text-white">
        <div class="card-body">
          <h5 class="card-title">Área Utilizada</h5>
          <h2>{{ info_desperdicio.area_usada_total }} {{ simbolo_area|default:"cm²" }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-center bg-warning">
        <div class="card-body">
          <h5 class="card-title">Desperdicio Total</h5>
          <h2>{{ info_desperdicio.desperdicio_total }} {{ simbolo_area|default:"cm²" }}</h2>
        </div>
      </div>
    </div>
  </div>
  
  <p class="text-center mt-3">Total de tableros generados: <strong>{{ num_tableros }}</strong></p>
  
  <hr>
  
  <!-- Tabla de desperdicio por tablero -->
  <h4 class="mt-4 fade-in">Detalle por Tablero</h4>
  <div class="card fade-in">
  <table class="table table-striped table-hover mb-0">
    <thead class="table-dark">
      <tr>
        <th>Tablero</th>
        <th>Piezas</th>
        <th>Área Usada</th>
        <th>Desperdicio</th>
        <th>Aprovechamiento</th>
      </tr>
    </thead>
    <tbody>
      {% for info in info_desperdicio.info_tableros %}
      <tr>
        <td><strong>Tablero {{ info.numero }}</strong></td>
        <td>{{ info.num_piezas }}</td>
        <td>{{ info.area_usada }} {{ simbolo_area|default:"cm²" }}</td>
        <td>{{ info.desperdicio }} {{ simbolo_area|default:"cm²" }}</td>
        <td>
          <div class="progress">
            <div class="progress-bar 
                 {% if info.porcentaje_uso < 30 %}bg-danger
                 {% elif info.porcentaje_uso < 60 %}bg-warning
                 {% else %}bg-success{% endif %}" 
                 role="progressbar" 
                 style="width: {{ info.porcentaje_uso }}%" 
                 aria-valuenow="{{ info.porcentaje_uso }}" 
                 aria-valuemin="0" aria-valuemax="100">
              {{ info.porcentaje_uso }}%
            </div>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
  
  <hr>
  
  <!-- Mostrar TODOS los tableros -->
  <h4 class="mt-4 fade-in">Tableros Generados</h4>
  <div class="row fade-in">
    {% for item in tableros_con_imagenes %}
    <div class="col-md-6 mb-4">
      <div class="card">
        <div class="card-header text-center bg-primary text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Tablero {{ item.numero }} de {{ num_tableros }}</h5>
          <a href="{% url 'opticut:descargar_png_tablero' optimizacion.id item.numero %}{% if numero_lista %}?ordenar_por=fecha_desc{% endif %}" 
             class="btn btn-sm btn-light" 
             title="Descargar imagen PNG">
            PNG
          </a>
        </div>
        <div class="card-body text-center">
          <img src="data:image/png;base64,{{ item.imagen }}" alt="Tablero {{ item.numero }}" class="img-fluid">
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  
  <hr>
  
  <!-- Botón para descargar PDF -->
  <div class="text-center mt-4 fade-in">
    {% if pdf_path %}
    <a href="/media/{{ pdf_path }}" class="btn btn-success btn-lg" download>
      Descargar PDF Completo
    </a>
    {% endif %}
  </div>
  
  <!-- Botón para volver -->
  <div class="text-center mt-4 mb-5 fade-in">
    <a href="{% url 'opticut:index' %}" class="btn btn-secondary btn-lg me-2">
      Volver al Optimizador
    </a>
    <a href="{% url 'opticut:mis_optimizaciones' %}" class="btn btn-info btn-lg">
      Ver Historial
    </a>
  </div>
</div>
{% endblock %}